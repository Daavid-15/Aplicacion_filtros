<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Tensores - Panel Operativo</title>
    
    <!-- Hojas de estilo externas para dise√±o y responsividad -->
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/screens.css">
    <link rel="stylesheet" href="styles/responsive.css">
</head>
<body>
    <body>


    <!-- Modal para configurar URL del backend -->
    <div id="backendModal" class="modal">
        <div class="modal-content">
            <h2>Introduce la direcci√≥n del servidor:</h2>
            <input type="text" id="backendUrl" placeholder="http://10.201.26.134:8000" value="http://10.201.26.134:8000">
            <button class="btn btn-primary" onclick="setBackendUrl()">Guardar y Continuar</button>
        </div>
    </div>

 



    <!-- ============================
            BARRA SUPERIOR (FUERA DEL CONTENEDOR)
        ============================ -->
<div class="container">
        <!-- Barra con estado general y √∫ltima actualizaci√≥n -->
    <div class="status-bar" id="statusBar">
        <div>
            <strong>Estado: <span id="statusText">CONECTANDO</span></strong>
        </div>
        <div>
            <span id="lastUpdate">√öltima actualizaci√≥n: Nunca</span>
        </div>
    </div>
    <!-- Indicadores de estado -->
    <div class="status-indicators">
        <div class="status-indicator" id="matchingStatus">
            <span>Matching:</span>
            <span id="matchingText">INACTIVO</span>
        </div>
        <div class="status-indicator" id="loadingStatus">
            <span>Carga Tensores:</span>
            <span id="loadingText">INACTIVO</span>
        </div>
        <div class="status-indicator" id="pendingStatus">
            <span>Recarga Pendiente:</span>
            <span id="pendingText">NO</span>
        </div>
    </div>
</div>

    <!-- Contenedor principal -->
<div class="container">
    <!-- ============================
            PANTALLA 1: FILTRADO (Aqu√≠ estan los botones y paneles)
    ============================ -->
    <div id="screenFilters" class="screen active">
        <h1>üìë Filtrado de Palanquillas</h1>

        <!-- Tarjetas estad√≠sticas -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="tensorsLoaded">0</div>
                <div class="stat-label">Tensores Cargados</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="vramUsage">0%</div>
                <div class="stat-label">Uso de VRAM</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="dateRanges">0</div>
                <div class="stat-label">Rangos de Fecha</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="steelTypes">0</div>
                <div class="stat-label">Filtros Activos</div>
            </div>
        </div>
        
        <!-- Botones de acciones r√°pidas -->
        <div class="quick-actions">
            <button class="btn btn-primary" onclick="reloadTensors()" id="reloadBtn">
                Recargar Tensores
            </button>
            <button class="btn btn-danger" onclick="clearVRAM()" id="clearBtn">
                Limpiar VRAM
            </button>
            <button class="btn btn-secondary" onclick="getStatus()" id="statusBtn">
                Actualizar Estado
            </button>
            <button class="btn btn-secondary" onclick="testConnection()" id="testBtn">
                Test Conexi√≥n
            </button>
        </div>
        
        <!-- Paneles de control -->
        <div class="control-grid">
            <!-- Control de rangos de fechas -->
            <div class="control-panel">
                <h3>üìÖ Rangos de Fechas</h3>
                
                <!-- Agregar nuevo rango -->
                <div class="form-group">
                    <label>Nuevo Rango:</label>
                    <div class="date-range">
                        <input type="datetime-local" id="startDate" value="2025-03-14T00:00">
                        <span>hasta</span>
                        <input type="datetime-local" id="endDate" value="2025-03-15T23:59">
                        <button class="btn btn-primary btn-small" onclick="addDateRange()">‚ûï</button>
                    </div>
                </div>
                
                <!-- Lista de rangos ya activos -->
                <div class="form-group">
                    <label>Rangos Activos:</label>
                    <div class="range-list" id="rangeList"></div>
                </div>
                
                <!-- L√≠mite de memoria de VRAM -->
                <div class="form-group">
                    <label>L√≠mite de Memoria (%):</label>
                    <input type="number" id="maxUsage" min="10" max="95" value="85" step="5">
                    <small>Porcentaje m√°ximo de VRAM a utilizar</small>
                </div>
            </div>
            
            <!-- Filtros de material -->
            <div class="control-panel">
                <h3>üî© Filtros de Material</h3>
                
                <div class="filter-section">
                    <label>Uso del Acero:</label>
                    <div class="steel-uses" id="steelUsesContainer"></div>
                </div>
                
                <div class="filter-section">
                    <label>Clase de Acero:</label>
                    <div class="steel-class" id="steelTypesContainer"></div>
                </div>
                
                <div class="filter-section">
                    <label>Tipo de Acero:</label>
                    <textarea 
                        id="steelRawTypesInput" 
                        class="raw-types-input" 
                        placeholder="Escribe tipos espec√≠ficos separados por comas. Ejemplo: H123A33, R456A55, B789E33"
                    ></textarea>
                </div>
                
                <!-- Ordenamiento de resultados -->
                <div class="form-group">
                    <label>Ordenamiento:</label>
                    <select id="sortOrder">
                        <option value="asc">M√°s antiguo primero</option>
                        <option value="desc">M√°s reciente primero</option>
                    </select>
                </div>
                <!-- Filtro por Consumed -->
                <div class="form-group">
                    <label for="consumed">Consumed:</label>
                    <select id="consumed">
                        <option value="No_Consumido">No_Consumido</option>
                        <option value="Todos">Todos</option>
                    </select>
                </div>

            </div>
        </div>
        
        <!-- Registro de actividad (log de eventos del sistema) -->
        <div class="control-panel">
            <h3>Registro de Actividad</h3>
            <div class="logs" id="logContainer">
                <div class="log-entry">[SYSTEM] Panel de control iniciado</div>
            </div>
        </div>

        <!-- Panel de diagn√≥stico t√©cnico -->
        <div class="debug-panel" id="debugPanel">
            <div class="debug-title">Panel de Diagn√≥stico</div>
            <div id="debugInfo">Iniciando diagn√≥stico...</div>
        </div>
    </div>

    <!-- ============================
            PANTALLA 2: CONFIGURACI√ìN
    ============================ -->
    <div id="screenConfig" class="screen">
        <h1>‚öôÔ∏è Configuraci√≥n del Sistema</h1>
        
        <!-- Par√°metros de LightGlue -->
        <div class="config-section">
            <h3>üéØ LightGlue - Par√°metros de Confianza</h3>
            <div class="config-grid">
                <div class="config-item">
                    <label>Depth Confidence (0-1)</label>
                    <input type="number" id="depthConfidence" min="0" max="1" step="0.01" value="0.7">
                    <small>Confianza acumulada para early stopping</small>
                </div>
                <div class="config-item">
                    <label>Width Confidence</label>
                    <input type="number" id="widthConfidence" min="0" max="1" step="0.01" value="0.85">
                    <small>Confianza de descarte de Puntos poco matcheables</small>
                </div>
                <div class="config-item">
                    <label>Filter Threshold</label>
                    <input type="number" id="filterThreshold" min="0" max="1" step="0.01" value="0.3">
                    <small>Confianza para Match_Correcto</small>
                </div>
                <div class="config-item">
                    <label>Layers (1-9)</label>
                    <input type="number" id="n_layers" min="1" max="9" step="1" value="4">
                    <small>N√∫mero de max capas para LightGlue</small>
                </div>
            </div>
        </div>

        <!-- Opciones de pre-procesamiento -->
        <div class="config-section">
            <h3>üîÑ Pre-procesamiento</h3>
            <div class="config-grid">
                <div class="config-item">
                    <label>Segmentar C√°mara</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="segmentarCamara" checked>
                        <span class="toggle-slider"></span>
                    </label>
                    <!--<small>Aplicar segmentaci√≥n por SAM</small>-->
                </div>
                <div class="config-item">
                    <label>Corregir Orientaci√≥n</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="corregirOrientacion" checked>
                        <span class="toggle-slider"></span>
                    </label>
                        <!--<small>Corregir orientaci√≥n de im√°genes</small>-->
                </div>
            </div>
        </div>

        <!-- Opciones de post-procesamiento -->
        <div class="config-section">
            <h3>üîÑ  Post-procesamiento</h3>
            <div class="config-grid">
                <div class="config-item">
                    <label>Activar Post-procesamiento</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="postprocesamiento" checked>
                        <span class="toggle-slider"></span>
                    </label>
                    <!--<small>Aplicar algoritmos de refinamiento</small>-->
                </div>
                <div class="config-item">
                    <label>RANSAC Reprojection Threshold</label>
                    <input type="number" id="ransacThreshold" min="1" max="100" step="1" value="20">
                    <!--<small>Umbral de reproyecci√≥n RANSAC (p√≠xeles)</small>-->
                </div>
            </div>
        </div>

        <!-- Batching -->
        <div class="config-section">
            <h3>üéØ Agrupacion en batches - Collage de Imagenes</h3>
            <div class="config-grid">
                <div class="config-item">
                    <label>N¬∫ Batches (1-20)</label>
                    <input type="number" id="numBatches" min="1" max="20" step="1" value="5">
                    <small>N√∫mero de im√°genes a procesar en cada batch</small>
                </div>
                <div class="config-item">
                    <label>Thresholds</label>
                    <textarea id="thresholdsConfig" rows="4" style="width:100%;">{"1": 0, "2": 25, "3": 20, "4": 10, "5": 10,"6": 10, "7": 9, "8": 9, "9": 8, "10": 8, "11": 7, "12": 7}</textarea>
                    <small>Mapa de umbrales por tama√±o de batch</small>
                </div>
                <div class="config-item">
                    <label>Default Threshold</label>
                    <input type="number" id="defaultThreshold" min="0" max="100" step="1" value="5">
                    <small>Umbral por defecto si no est√° definido en el mapa</small>
                </div>
            </div>
        </div>

        <!-- Bot√≥n para aplicar cambios de configuraci√≥n -->
        <button class="btn btn-success save-config-btn" onclick="applyConfiguration()" id="applyConfigBtn">
            ‚úÖ Aplicar Configuraci√≥n
        </button>
    </div>

<!-- ============================
    PANTALLA 3: C√ÅMARA SIMPLIFICADA
============================ -->
    <div id="screenCamera" class="screen">
        <h1>üì∏ C√°mara BT-Portable</h1>
        
        <div class="camera-container">
            <!-- Input de archivo oculto -->
            <input type="file" id="cameraFileInput" accept="image/*" capture="environment" style="display: none;">
            
            <!-- Vista previa de la imagen capturada - AGREGAR CLASE -->
            <div class="image-preview-container">
                <img id="imagePreview" class="image-preview">
            </div>
            
            <!-- Botones de control -->
            <div class="camera-controls">
                <button class="btn btn-primary" onclick="openCamera()" id="openCameraBtn">
                    üì∑ Abrir C√°mara
                </button>
                
                <!-- Campo para el nombre de la imagen -->
                <div id="imageNameInput" style="display: none; margin: 15px 0; padding: 15px; background: #e8f4f8; border-radius: 8px; width: 100%; max-width: 400px;">
                    <label for="imageName" style="display: block; margin-bottom: 8px; font-weight: bold; color: #2c3e50;">
                        üìù Nombre de la imagen:
                    </label>
                    <input 
                        type="text" 
                        id="imageName" 
                        placeholder="Nombre de la imagen (sin extensi√≥n)"
                        style="width: 100%; padding: 10px; border: 2px solid #3498db; border-radius: 5px; font-size: 14px;"
                    >
                    <small style="display: block; margin-top: 5px; color: #666;">
                        üí° Si dejas vac√≠o, se usar√° la fecha/hora actual como nombre
                    </small>
                </div>
                
                <!-- Contenedor para los botones -->
                <div class="buttons-container">

                    <button class="btn btn-danger" onclick="discardImage()" id="discardImageBtn" style="display: none;">
                        ‚ùå Descartar
                    </button>
                    <button class="btn btn-success" onclick="sendImage()" id="sendImageBtn" style="display: none;">
                        üì§ Enviar Imagen
                    </button>
                </div>
            </div>
            
            <!-- Estado -->
            <div id="cameraStatus" class="camera-status"></div>
            
            <!-- Configuraci√≥n de Resoluci√≥n -->
            <div class="quality-controls" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <h4>Configuraci√≥n Resoluci√≥n</h4>
                
                <div class="form-group">
                    <label for="imageWidth">Ancho m√°ximo (px):</label>
                    <input type="number" id="imageWidth" min="320" max="4096" value="4096" 
                        style="width: 100px; display: inline-block; margin-left: 10px;">
                </div>
                
                <div class="form-group">
                    <label for="imageQuality">Calidad JPEG:</label>
                    <input type="range" id="imageQuality" min="0.1" max="1" step="0.1" value="1"
                        style="width: 150px; display: inline-block; margin-left: 10px;">
                    <span id="qualityValue">1</span>
                </div>
                
                <div id="imageInfo" style="font-size: 12px; color: #666; margin-top: 10px;">
                    Tama√±o estimado: 840 KB (1024px, calidad 1)
                </div>
            </div>
        </div>
    </div>

    <!-- ============================
        BARRA DE NAVEGACI√ìN INFERIOR
    ============================ -->
    <div class="bottom-nav">
        <!-- Bot√≥n para ir a la pantalla de filtrado -->
        <div class="nav-item active" onclick="switchScreen('screenFilters', this)"> <!-- Este empieza primero marcado como activo -->
            <div class="nav-icon">üìë</div>
            <div class="nav-label">Filtrado</div>
        </div> 
    <!-- Bot√≥n para ir a c√°mara -->
        <div class="nav-item" onclick="switchScreen('screenCamera', this)">
            <div class="nav-icon">üì∑</div>
            <div class="nav-label">C√°mara</div>
        </div>
        <!-- Bot√≥n para ir a configuraci√≥n -->
        <div class="nav-item" onclick="switchScreen('screenConfig', this)">
            <div class="nav-icon">‚öôÔ∏è</div>
            <div class="nav-label">Configuraci√≥n</div>
        </div>
    </div>

    <!-- ============================
         Scripts de la aplicaci√≥n
    ============================ -->
    <script src="js/config.js"></script>
    <script src="js/api.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/navigation.js"></script>
    <script src="js/camera.js"></script>
    <script src="js/app.js"></script>
</body>
</html>
